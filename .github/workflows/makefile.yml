name: ARM64 Kernel CI (Pure Clang Cross-Compile)
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest  # 使用标准x86 Runner
    timeout-minutes: 45

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          clang-18 \
          lld-18 \
          libssl-dev \
          libelf-dev \
          flex \
          bison \
          bc \
          ccache

    - name: Prepare Clang Environment
      run: |
        # 配置LLVM符号链接
        sudo ln -sf /usr/bin/clang-18 /usr/bin/clang
        sudo ln -sf /usr/bin/lld-18 /usr/bin/ld.lld
        
        # 配置ccache
        sudo mkdir -p /usr/lib/ccache
        sudo ln -sf /usr/bin/ccache /usr/lib/ccache/clang

    - name: Build Kernel (ARM64 Cross-Compile)
      env:
        ARCH: arm64
        SUBARCH: arm
      run: |
        # 纯Clang交叉编译命令
        make -j32 O=out \
          CC="ccache clang" \
          LD=ld.lld \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          LLVM_IAS=1 \
          KCFLAGS="--target=aarch64-linux-gnu \
                   -Wno-unused-but-set-variable \
                   -Wno-implicit-function-declaration \
                   KCFLAGS="--target=aarch64-linux-gnu \
                   -Wno-unused-but-set-variable \
                   -Wno-implicit-function-declaration \
                   -Wno-unused-variable -Wno-unused-function -Wno-unused-label -fno-PIE" \
          evergo_defconfig

        make -j32 O=out \
          CC="ccache clang" \
          LD=ld.lld \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          LLVM_IAS=1 \
          KCFLAGS="--target=aarch64-linux-gnu \
                   -Wno-unused-but-set-variable \
                   -Wno-implicit-function-declaration \
                   -Wno-unused-variable -Wno-unused-function -Wno-unused-label -fno-PIE"

    - name: Package Kernel
      run: |
        cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
        zip -r9 AnyKernel3.zip AnyKernel3/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Zip
        path: AnyKernel3.zip
